datasource db {
  provider = "postgresql"
}

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

enum UserRole {
  USER
  ADMIN
}

enum Privacy {
  PUBLIC
  FRIENDS
  ONLY_ME
}

enum MediaType {
  IMAGE
  VIDEO
}

enum AiStatus {
  OK
  FLAGGED
  REJECTED
}

enum ReactionTargetType {
  POST
  COMMENT
}

enum ReactionType {
  LIKE
  LOVE
  HAHA
  WOW
  SAD
  ANGRY
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

enum ConversationType {
  DIRECT
  GROUP
  BOT
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  CALL
}

enum NotificationType {
  POST_LIKED
  POST_COMMENTED
  COMMENT_REPLIED
  FRIEND_REQUEST_RECEIVED
  FRIEND_REQUEST_ACCEPTED
  NEW_MESSAGE
  ADMIN_ANNOUNCEMENT
  COMMENT_REACTED
}

enum ConversationMemberRole {
  MEMBER
  OWNER
}

enum PasswordResetPurpose {
  USER_SELF
  ADMIN_ASSISTED
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  name         String
  avatarUrl    String?
  bio          String?

  role            UserRole @default(USER)
  isEmailVerified Boolean  @default(false)
  isBanned        Boolean  @default(false)

  isOnline   Boolean?  @default(false)
  lastSeenAt DateTime?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens           RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  posts     Post[]
  comments  Comment[]
  reactions Reaction[]

  friendRequestsSent     FriendRequest[] @relation("FriendRequestFrom")
  friendRequestsReceived FriendRequest[] @relation("FriendRequestTo")

  friendsAsUser1 Friend[] @relation("FriendUser1")
  friendsAsUser2 Friend[] @relation("FriendUser2")

  blocksInitiated Block[] @relation("Blocker")
  blocksReceived  Block[] @relation("Blocked")

  inviteCodesOwned FriendInviteCode[] @relation("InviteOwner")
  inviteCodesUsed  FriendInviteCode[] @relation("InviteUsedBy")

  location UserLocation?

  conversationsOwned Conversation[]

  conversationMemberships ConversationMember[]

  messagesSent Message[] @relation("Message_sender")

  messageReactions MessageReaction[]

  messageReads MessageRead[]

  notifications Notification[]

  adminActions AdminActionLog[]
}

model RefreshToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
}

model EmailVerificationToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  purpose PasswordResetPurpose @default(USER_SELF)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([purpose])
}

model Post {
  id       String @id @default(uuid())
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  text    String?
  privacy Privacy @default(PUBLIC)

  aiStatus AiStatus @default(OK)
  aiReason String?

  sharedFrom   Post?   @relation("ShareRelation", fields: [sharedFromId], references: [id])
  sharedFromId String?

  shares Post[] @relation("ShareRelation")

  media     PostMedia[]
  comments  Comment[]
  reactions Reaction[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([authorId])
  @@index([sharedFromId])
}

model PostMedia {
  id     String @id @default(uuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  type  MediaType
  url   String
  size  Int?
  order Int       @default(0)

  @@index([postId])
}

model Comment {
  id     String @id @default(uuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  parentComment   Comment?  @relation("CommentReply", fields: [parentCommentId], references: [id])
  parentCommentId String?
  replies         Comment[] @relation("CommentReply")

  content  String
  aiStatus AiStatus @default(OK)
  aiReason String?

  reactions Reaction[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
}

model Reaction {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  targetType ReactionTargetType
  targetId   String
  type       ReactionType

  createdAt DateTime @default(now())
  post      Post?    @relation(fields: [postId], references: [id])
  postId    String?
  comment   Comment? @relation(fields: [commentId], references: [id])
  commentId String?

  @@unique([userId, targetType, targetId])
  @@index([targetId])
}

model FriendRequest {
  id         String @id @default(uuid())
  fromUser   User   @relation("FriendRequestFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId String
  toUser     User   @relation("FriendRequestTo", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   String

  status FriendRequestStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromUserId, toUserId, status])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
}

model Friend {
  id      String @id @default(uuid())
  user1   User   @relation("FriendUser1", fields: [userId1], references: [id], onDelete: Cascade)
  userId1 String
  user2   User   @relation("FriendUser2", fields: [userId2], references: [id], onDelete: Cascade)
  userId2 String

  createdAt DateTime @default(now())

  @@unique([userId1, userId2])
  @@index([userId1])
  @@index([userId2])
}

model Block {
  id        String @id @default(uuid())
  blocker   User   @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blockerId String
  blocked   User   @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blockedId String

  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model FriendInviteCode {
  id   String @id @default(uuid())
  code String @unique

  owner   User   @relation("InviteOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String

  usedByUser   User?   @relation("InviteUsedBy", fields: [usedByUserId], references: [id])
  usedByUserId String?

  createdAt DateTime  @default(now())
  usedAt    DateTime?
  expiresAt DateTime?

  @@index([code])
  @@index([ownerId])
  @@index([usedByUserId])
}

model UserLocation {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @id

  lat            Float
  lng            Float
  sharingEnabled Boolean @default(false)

  updatedAt DateTime @updatedAt
}

model Conversation {
  id      String           @id @default(uuid())
  type    ConversationType
  title   String?
  ownerId String?
  owner   User?            @relation(fields: [ownerId], references: [id])

  members  ConversationMember[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([ownerId])
}

model ConversationMember {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  role ConversationMemberRole @default(MEMBER)

  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  sender   User   @relation("Message_sender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId String

  type     MessageType
  content  String?
  mediaUrl String?

  replyTo          Message?  @relation("MessageReply", fields: [replyToMessageId], references: [id])
  replyToMessageId String?
  replies          Message[] @relation("MessageReply")

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reactions MessageReaction[]
  reads     MessageRead[]

  @@index([conversationId])
  @@index([senderId])
  @@index([replyToMessageId])
  @@index([conversationId, createdAt, id])
}

model MessageReaction {
  id        String  @id @default(uuid())
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type ReactionType

  createdAt DateTime @default(now())

  @@unique([messageId, userId])
  @@index([userId])
}

model MessageRead {
  id        String  @id @default(uuid())
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  readAt DateTime?

  @@unique([messageId, userId])
  @@index([userId])
}

model Notification {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type    NotificationType
  payload Json

  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([isRead])
}

model AdminActionLog {
  id String @id @default(uuid())

  admin   User   @relation(fields: [adminId], references: [id], onDelete: Cascade)
  adminId String

  actionType String
  targetType String?
  targetId   String?
  metadata   Json?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([targetType, targetId])
}
