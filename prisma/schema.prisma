datasource db {
  provider = "postgresql"
}

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

enum UserRole {
  USER
  ADMIN
}

enum Privacy {
  PUBLIC
  FRIENDS
  ONLY_ME
}

enum MediaType {
  IMAGE
  VIDEO
}

enum AiStatus {
  OK
  FLAGGED
  REJECTED
}

enum ReactionTargetType {
  POST
  COMMENT
}

enum ReactionType {
  LIKE
  LOVE
  HAHA
  WOW
  SAD
  ANGRY
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  name         String
  avatarUrl    String?
  bio          String?

  role            UserRole @default(USER)
  isEmailVerified Boolean  @default(false)
  isBanned        Boolean  @default(false)

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens           RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  posts     Post[]
  comments  Comment[]
  reactions Reaction[]
}

model RefreshToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
}

model EmailVerificationToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Post {
  id       String @id @default(uuid())
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  text    String?
  privacy Privacy @default(PUBLIC)

  aiStatus AiStatus @default(OK)
  aiReason String?

  sharedFrom   Post?   @relation("ShareRelation", fields: [sharedFromId], references: [id])
  sharedFromId String?

  shares Post[] @relation("ShareRelation")

  media     PostMedia[]
  comments  Comment[]
  reactions Reaction[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([authorId])
  @@index([sharedFromId])
}

model PostMedia {
  id     String @id @default(uuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  type  MediaType
  url   String
  size  Int?
  order Int       @default(0)

  @@index([postId])
}

model Comment {
  id     String @id @default(uuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  parentComment   Comment?  @relation("CommentReply", fields: [parentCommentId], references: [id])
  parentCommentId String?
  replies         Comment[] @relation("CommentReply")

  content  String
  aiStatus AiStatus @default(OK)
  aiReason String?

  reactions Reaction[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
}

model Reaction {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  targetType ReactionTargetType
  targetId   String
  type       ReactionType

  createdAt DateTime @default(now())
  post      Post?    @relation(fields: [postId], references: [id])
  postId    String?
  comment   Comment? @relation(fields: [commentId], references: [id])
  commentId String?

  @@unique([userId, targetType, targetId])
  @@index([targetId])
}
